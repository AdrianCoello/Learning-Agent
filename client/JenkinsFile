pipeline {
  agent any
  tools { nodejs 'node20' }

  environment {
    CI = 'true'
    NODE_ENV = 'production'
    VITE_URL = 'http://localhost:3000'
  }

  stages {
    stage('Checkout'){ steps { checkout scm } }

    stage('Build frontend') {
      steps {
        dir('client') {
          sh 'node -v && npm -v'
          sh 'npm ci --include=dev'
          sh 'npm run build'
        }
      }
    }

    stage('Artefactos') {
      steps {
        archiveArtifacts artifacts: 'client/dist/**', fingerprint: true
      }
    }
    stage('Deploy to Vercel (prod)') {
      steps {
        withCredentials([
          string(credentialsId: 'VERCEL_TOKEN',    variable: 'VERCEL_TOKEN'),
          string(credentialsId: 'VERCEL_ORG_ID',   variable: 'VERCEL_ORG_ID'),
          string(credentialsId: 'VERCEL_PROJECT_ID', variable: 'VERCEL_PROJECT_ID')
        ]) {
          sh '''
            set -e
            # Verificar CLI
            npx --yes vercel@latest --version

            # Para proyectos Vite (estático), subimos la carpeta dist directamente
            # --prod: a producción
            # --yes/--confirm: no interactivo
            # --token/--org-id/--project-id: autenticación + destino
            # Nota: dist/ debe existir del stage Build
            npx --yes vercel@latest deploy dist \
              --prod \
              --yes \
              --confirm \
              --token "$VERCEL_TOKEN" \
              --org-id "$VERCEL_ORG_ID" \
              --project-id "$VERCEL_PROJECT_ID"
          '''
        }
      }
    }
  }
}
